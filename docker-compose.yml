version: "3.9"

x-common-variables: &common-variables
  AMQP_URI: amqp://guest:guest@rabbitmq:5672/
  WAIT_HOSTS: redis:6379
#  WAIT_HOSTS: "redis:6379,rabbitmq:5672"
  WAIT_HOSTS_TIMEOUT: 300
  WAIT_SLEEP_INTERVAL: 10
  WAIT_HOST_CONNECT_TIMEOUT: 30
  CONVERT_TO_WEBP_QUEUE: convert
  SEND_WEBP_TO_WHATSAPP_QUEUE: complete
  LOG_METRIC_QUEUE : metric

services:
  whatsticker-master:
    build: ./master
    restart: always
    depends_on:
      - rabbitmq
    command: bash -c "/wait && go run main.go -log-level DEBUG"
    volumes:
      - type: bind
        source: ./master/db
        target: /project/db
      - images:/project/images
      - videos:/project/videos
    environment:
      <<: *common-variables

  whatsticker-worker:
    build: ./worker
    restart: always
    platform: linux/x86_64
    depends_on:
      - rabbitmq
    command: bash -c "/wait && go run main.go"
    volumes:
      - images:/project/images
      - videos:/project/videos
    deploy:
      mode: replicated
      replicas: 3
    environment:
      <<: *common-variables
        
  whatsticker-logger:
    build: ./logger
    restart: always
    depends_on:
      - rabbitmq
    command: bash -c "/wait && go run main.go"
    environment:
      <<: *common-variables
    ports: 
      - "9091:9091"

  rabbitmq:
    restart: always
    hostname: rabbitmq
    image: rabbitmq:3-management-alpine
    ports:
      - 5672:5672
      - 8080:15672
#    volumes:
#      - /var/lib/rabbitmq/
#      - /var/log/rabbitmq/

#  redis:
#    restart: always
#    image: redis:alpine

volumes:
  images:
  videos:
